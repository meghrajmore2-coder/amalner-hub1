<script type="module">
/* ---------- Firebase + Firestore client code for Amalner Hub (Admin-only post creation) ---------- */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import {
  getFirestore, collection, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, increment, addDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

/* --------- REPLACE THIS CONFIG with your Firebase project's config --------- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  // ...other keys from Firebase console
};
/* -------------------------------------------------------------------------- */

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* DOM refs */
const postsDiv = document.getElementById('posts');
const adminToggleBtn = document.querySelector('button[onclick="toggleAdmin()"]');
let currentUser = null;

/* Real-time listener for posts */
const postsCol = collection(db, 'posts');
const postsQuery = query(postsCol, orderBy('createdAt', 'desc'));

/* Render helper */
function makePostElement(id, data, isAdmin){
  const div = document.createElement('div');
  div.className = 'post';
  div.dataset.id = id;
  div.innerHTML = `
    <h4>${escapeHtml(data.title)}</h4>
    <p>${escapeHtml(data.content)}</p>
    <div class="actions">
      <button class="like-btn">üëç ${data.likes || 0}</button>
      <button class="comment-open-btn">üí¨ Comment</button>
      ${isAdmin ? '<button class="delete-btn">üóë Delete</button>' : ''}
    </div>
    <div class="comments" style="margin-top:8px;"></div>
  `;
  
  // like handler
  div.querySelector('.like-btn').addEventListener('click', async () => {
    const docRef = doc(db, 'posts', id);
    await updateDoc(docRef, { likes: increment(1) });
  });

  // delete handler (admin only)
  if (isAdmin){
    div.querySelector('.delete-btn').addEventListener('click', async () => {
      if (!confirm('Delete this post?')) return;
      await deleteDoc(doc(db, 'posts', id));
    });
  }

  // comment open ‚Äî inline form
  div.querySelector('.comment-open-btn').addEventListener('click', () => {
    const commentsDiv = div.querySelector('.comments');
    if (commentsDiv.querySelector('form')) return;
    const form = document.createElement('form');
    form.innerHTML = `
      <input type="text" name="comment" placeholder="Write comment..." style="width:70%;padding:6px;border-radius:4px;border:1px solid #ccc" />
      <button type="submit" style="padding:6px 8px;margin-left:6px;">Post</button>
    `;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = form.comment.value.trim();
      if (!text) return;
      await addDoc(collection(db, 'posts', id, 'comments'), {
        text,
        author: currentUser?.email || 'Guest',
        createdAt: Date.now()
      });
      form.comment.value = '';
    });
    commentsDiv.appendChild(form);
    const commentsQuery = query(collection(db, 'posts', id, 'comments'), orderBy('createdAt', 'asc'));
    onSnapshot(commentsQuery, (snap) => {
      commentsDiv.querySelectorAll('.comment-item').forEach(n => n.remove());
      snap.forEach(csnap => {
        const c = csnap.data();
        const el = document.createElement('div');
        el.className = 'comment-item';
        el.style.marginTop = '8px';
        el.innerHTML = `<small style="color:#666">${escapeHtml(c.author)}</small><div>${escapeHtml(c.text)}</div>`;
        commentsDiv.appendChild(el);
      });
    });
  });
  return div;
}

/* Real-time subscription to posts */
onSnapshot(postsQuery, (snap) => {
  postsDiv.innerHTML = '';
  snap.forEach(docSnap => {
    const data = docSnap.data();
    const id = docSnap.id;
    const isAdmin = currentUser?.email === "your-admin-email@example.com"; // Replace this with your admin email
    const el = makePostElement(id, data, isAdmin);
    postsDiv.appendChild(el);
  });
});

/* Admin login flow */
window.toggleAdmin = async function(){
  if (currentUser){
    await signOut(auth);
    alert('Signed out');
    return;
  }
  const email = prompt('Admin email:');
  const pass = prompt('Password:');
  if (!email || !pass) return;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    alert('Signed in as admin');
  } catch (err){
    alert('Sign-in failed: ' + err.message);
  }
};

/* Track auth state */
onAuthStateChanged(auth, (user) => {
  currentUser = user;
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.style.display = user ? 'inline-block' : 'none';
  });
});

/* Helper */
function escapeHtml(s){
  return (s+'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
</script>
